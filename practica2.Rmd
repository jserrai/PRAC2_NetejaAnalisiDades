---
title: "practica2"
author: "Paula Jordi"
date: "30/12/2020"
output: html_document
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(ggplot2)
library(patchwork)
library(dplyr)
library(scales)
library(Hmisc)
```

## 1. Integració i selecció de les dades d’interès a analitzar:

Obtenim les dades del repositori: https://www.kaggle.com/lantanacamara/hong-kong-horse-racing
Aquest conté dades dels resultats de les 1561 curses de cavalls fetes a Hong Kong entre el 14 de Setembre del 2014 i el 16 de Juliol de 2017. Aquest està organitzat amb dos fitxers: race-result-horse.csv i race-result-race.csv:

```{r}
horse.data <- read.csv("./race-result-horse.csv")
race.data <- read.csv("./race-result-race.csv")
```

Unifiquem els dos datasets en un a partir de la variable comú als dos fitxers. Aquesta fa referencia al identificador de la carrera: "race_id"

```{r}
dataset <- merge(horse.data, race.data, by = "race_id")
attach(dataset) # Per poder fer referencia directament a les variables
dim(dataset)
```


## 2 .Neteja de les dades:

Abans de netejar les dades, hem de mirar què hi tenim a cada columna. Per fer-ho utilizarem la funció summary() que ens permet visualitzar i fer-nos una idea general general el dataset: 

```{r message= FALSE, warning=FALSE}
#head(dataset,5)
str(dataset)
colnames(dataset)
```

Com podem veure, tenim 30 variables amb 30189 observacions. Com que hi ha moltes variables que estan repetides o que no aporten una informació vàlida, n'eliminarem algunes:

1. "incident_report": Són comentaris sobre la cursa, no utilitzarem aquesta variable per als nostres anàlisis, per tant els podem eliminar.
2. "running_position_X": Entenem que són les posicions intermitjes de la carrera. No ens aporta informació sobre abans de la carrera, sinó durant aquesta.
3. "SRC": Tampoc ens aporta res més que el nom dels fitxers de dades.
4. "horse_number": Depèn de cada cursa i no identifica el cavall, per tant deixem només el "horse_name".
5. "race_number": També és reduntant amb les altres variables.
6. "race_date": La data de la carrera és indiferent per l'anàlisi de les dades. 
7. "sectional_time": Tindrem en compte només el temps total de la carrera, no de cada volta.
8. "horse_id" : Ja tenim un identificador pel cavall, aques és redundant.
9. “length_behind_winner” : És redundant, ja tenim la posició final de la cursa.

```{r message= FALSE, warning=FALSE}
eliminar <- c("running_position_1","running_position_2","running_position_3","running_position_4","running_position_5","running_position_6","incident_report","src","race_date","race_number","horse_number","horse_id","sectional_time","length_behind_winner")
dataset_clean <- dataset[ , !(names(dataset) %in% eliminar)]
```


### 2.1. Les dades contenen zeros o elements buits? Com gestionaries aquests casos?


Fent una ullada al dataset, veiem que alguns valors NA estan representats com a "---", "N", "SH" o "HD". Canviarem aquests valors a NA per a poder treballar amb la mateixa notació. 
A més a més, a la columna de "length_behind_winner" (la distància del cavall en qüestió en relació al primer), ens trobem valors representats com a "-". Aquests corresponen al guanyador de la cursa, el quel no té distància sobre sí mateix, és a dir no són valors buits sinó que representen distància 0. Modificarem la notació per "0".
A la variable finishing_position, tenim diversos valors no numèrics, aquests estan representats amb diferents lletres. Per a utilitzar la mateixa notació, canviarem la variable a numèrica i aquells valors no numèrics passaran a estar representats amb "NA".

```{r echo=TRUE, message=FALSE, warning=FALSE}
dataset_clean[dataset_clean == "-"] <- "0"
dataset_clean[dataset_clean == "---"] <- NA
dataset_clean[dataset_clean == "N"] <- NA
dataset_clean[dataset_clean == "SH"] <- NA
dataset_clean[dataset_clean == "HD"] <- NA
dataset_clean$finishing_position  <- lapply(dataset_clean$finishing_position, as.character)
dataset_clean$finishing_position <- unlist(lapply(dataset_clean$finishing_position, as.integer)) # tots aquells valors que no s'hagin pogut transformar són els no numèrics, i restaran com a "NA".
```

Un cop ja tenim tots els valors buits amb la mateixa identificació, podem mirar si tenim gaires elements buits, i en quines variables.

```{r echo=TRUE, message=FALSE, warning=FALSE}
#paste("Nombre de valors nulls:", sum(is.na(race_id)))
colSums(is.na(dataset_clean))
```

Podem observar que tenim alguns valors buits al nostre dataset. Primer ens centrarem en la variable finishing_position. Determinem quin % de valors buits representa, per a poder decidir com actuem:

```{r message= FALSE, warning=FALSE}
paste("Proporció de valors nulls de la variable finishing_position:", format(sum(is.na(dataset_clean$finishing_position))/nrow(dataset_clean), format = "f", digits = 3), "%")
```

Veiem que representa un valor molt baix de totes les nostres dades, així que aquest cas el podem gestionar eliminant les observacions nules. Si representés una proporció més gran de les nostres dades, al voltant de 15-20% hauriem d'imputar els missing values, utilitzant un anàlisi de regressió. 
Observem quans valors nuls tenim ara:

```{r message= FALSE, warning=FALSE}
dataset_clean <- dataset_clean[!(is.na(dataset_clean$finishing_position)),] # eliminem les files sense resultats.

colSums(is.na(dataset_clean))
```


Un op netejada la variable, ja no tenim més valors buits en les altres columnes.
Tot i així, si mirem al dataset original, veiem que hi havia bastants valors buits. Aquests, estaven concentrats en les columnes que hem eliminat perque no ens aportaven informació útil.

```{r echo=TRUE, message=FALSE, warning=FALSE}
#summary(dataset[,-30])
colSums(is.na(dataset))
```

### 2.2. Identificació i tractament de valors extrems

Per a visualitzar els valors extrems, primer escollirem aquelles variables en les quals podem trobar-nos valors extrems.
De totes les variables del nostre dataset, només les variables continues poden tenir valors extrems, aquelles que categòriques o identificatives no en tindran ("race_id", "horse_name", "jockey", "trainer", "draw", "race_course", "race_name", "race_class", "track", "track_condition", "finishing_position", "length_behind_winner","race_distance" ).
Primer transformem les variables continues a numèriques per poder trobar-ne els outliers.

```{r echo=TRUE, message=FALSE, warning=FALSE}

dataset_clean$actual_weight <- unlist(lapply(dataset_clean$actual_weight, as.integer))
dataset_clean$declared_horse_weight <- unlist(lapply(dataset_clean$declared_horse_weight, as.integer))
dataset_clean$finish_time <-  period_to_seconds(ms(dataset_clean$finish_time))
dataset_clean$win_odds <- unlist(lapply(dataset_clean$win_odds, as.numeric))
dataset_clean$race_distance <- unlist(lapply(dataset_clean$race_distance, as.integer))
```


> **Visualitzem els outliers:**

En el nostre dataset, hi tenim diverses curses de cavalls, aquestes tenen diferents distàncies de 1000m a 2400m. Hem de determinar els outliers tenint en compte la distància de la cursa, sinó aquest factor crearà un bias en els costres resultats.

Utilitzem una representació gràfica (histograma i boxplot), per a visualitzar i detectar els outliers:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.width=10, fig.height=15}
hist_f <- ggplot(data = dataset_clean, aes(x=dataset_clean$finish_time)) + 
  facet_grid(rows = vars(dataset_clean$race_distance), scale = "free_y", space='free') +
  geom_histogram(binwidth=1, fill="#0c4c8a") +
  theme_minimal() +
  ggtitle("Histograma - Finnish time")

hist_aw <- ggplot(data = dataset_clean, aes(x=dataset_clean$actual_weight)) + 
  facet_grid(rows = vars(dataset_clean$race_distance), scale = "free_y", space='free') +
  geom_histogram(binwidth=1, fill="#0c4c8a") +
  theme_minimal() +
  ggtitle("Histograma - Actual Weight")

hist_dw <- ggplot(data = dataset_clean, aes(x=dataset_clean$declared_horse_weight)) + 
  facet_grid(rows = vars(dataset_clean$race_distance), scale = "free_y", space='free') +
  geom_histogram(binwidth=1, fill="#0c4c8a") +
  theme_minimal() +
  ggtitle("Histograma - Declared Weight")

hist_wo <- ggplot(data = dataset_clean, aes(x=dataset_clean$win_odds)) + 
  facet_grid(rows = vars(dataset_clean$race_distance), scale = "free_y", space='free') +
  geom_histogram(binwidth=1, fill="#0c4c8a") +
  theme_minimal() +
  ggtitle("Histograma - Win Odds")

box_f <- ggplot(dataset_clean) +
  aes(x = "", y = dataset_clean$finish_time) +
  facet_grid(cols = vars(dataset_clean$race_distance), scale = "free") +
  geom_boxplot(fill = "#0c4c8a", outlier.colour = "red") +
  ggtitle("Boxplot - Finnish time") +
  ylab("") +
  theme_minimal()

box_aw <- ggplot(dataset_clean) +
  aes(x = "", y = dataset_clean$actual_weight) +
  facet_grid(cols = vars(dataset_clean$race_distance), scale = "free") +
  geom_boxplot(fill = "#0c4c8a",outlier.colour = "red") +
  ggtitle("Boxplot - Actual Weight") +
  ylab("") +
  theme_minimal()

box_dw <- ggplot(dataset_clean) +
  aes(x = "", y = dataset_clean$declared_horse_weight) +
  facet_grid(cols = vars(dataset_clean$race_distance), scale = "free") +
  geom_boxplot(fill = "#0c4c8a",outlier.colour = "red") +
  ggtitle("Boxplot - Declared weight") +
  ylab("") +
  theme_minimal()

box_wo <- ggplot(dataset_clean) +
  aes(x = "", y = dataset_clean$win_odds) +
  facet_grid(cols = vars(dataset_clean$race_distance), scale = "free") +
  geom_boxplot(fill = "#0c4c8a",outlier.colour = "red") +
  ggtitle("Boxplot - Win Odds") +
  ylab("") +
  theme_minimal()

hist_f + hist_aw + hist_dw + hist_wo + box_f + box_aw + box_dw + box_wo +  plot_layout(nrow = 4, ncol = 2)
```

> **Ara eliminem els outliers de cada una de les variables:**

Eliminarem tots aquells valors outliers. Tot i així, podem observar que a la variable _win_odds_, tots els outliers són els cavalls que tenen més probabilitats de guanyar. Com que el nostre estudi té a veure amb aquests, no eliminarem aquests outliers del nostre dataset i els tindrem en compte pels anàlisis posteriors.

```{r echo=TRUE, message=FALSE, warning=FALSE}
out_aw <- unlist(ggplot_build(box_aw)[["data"]][[1]][["outliers"]])
ind_aw <- which(dataset_clean$actual_weight %in% c(out_aw))

out_f <- unlist(ggplot_build(box_f)[["data"]][[1]][["outliers"]])
ind_f <- which(dataset_clean$finish_time %in% c(out_f))

out_dw <- unlist(ggplot_build(box_dw)[["data"]][[1]][["outliers"]])
ind_dw <- which(dataset_clean$declared_horse_weight %in% c(out_dw))

dataset_outliers <- dataset_clean[-c(ind_f,ind_dw,ind_aw),]
paste("Hem eliminat", (nrow(dataset_clean)-nrow(dataset_outliers)) , "outliers.")
paste("Ara el nostre dataset té", nrow(dataset_outliers), "observacions.")
```

Rescalesm els dos pesos a variables entre 0 i 1

```{r label="1"}
dataset_clean$actual_weight<-rescale(dataset_clean$actual_weight)
dataset_clean$declared_horse_weight<-rescale(dataset_clean$declared_horse_weight)
```


mirem la correlación entre els valors que són numerics, treiem en aquest cas la variable que es vol predir, que es el temps en que ha d'acabar un cavall, i fem la predicció per cada una de les diferents carreres, ja que no es comporten igual i com podem veure hi ha una correlació directe entre el temps de la cursa i la distancia.

```{r label="corelacio"}
cor(x=dataset_clean$finish_time, y=dataset_clean$race_distance)
```


mirem la resta de variables (treient la variable que tenim corelacionada amb el temps)
```{r label="rcorr" }
eliminar <- c("race_distance")
dataset_clean <- dataset_clean[ , !(names(dataset_clean) %in% eliminar)]
num <- select_if(dataset_clean, is.numeric)

cat <- select_if(dataset_clean, is.factor)
for (name in colnames(cat)) {
  cat[name] <- unlist(lapply(cat[name], as.numeric))
}

dataset_numerical <- data.frame(num,cat)
rcorr(as.matrix(dataset_numerical), type = "pearson")


```

en aquest cas veiem com la variable _win_odds_ (la provabilitat de guanyar abans d'iniciar la cursa) té una correlació força alta amb la posició final de la cursa, cosa que es pot entendre per ser un bon cavall.
En aquest cas, la posició final de la cursa dependrà molt de la resta de cavalls que hi hagui i no del propi cavall, per tant, també es podria eliminar j aqu eno afecta a la predicció del resultat, sinó al resultat de cada cursa.

